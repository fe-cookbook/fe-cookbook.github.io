<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>axios 的 constructor</title>
        <link rel="stylesheet" href="../assets/style.css">
        <link rel="shortcut icon" href="https://fe-cookbook.github.io/favicon.png">
    </head>
    
    <body>
        <div class="app">
        <header class="navbar"><p><a class="logo" href="/">fe-cookbook</a></p>
<div class="menus">
<a class="item" href="/">首页</a>
</div>
</header>
        <aside class="sidebar">
    <ul class="ul-0"><li class="li-1"><p class="a-2">cookbook</p></li><li class="li-1"><p class="a-2">axios</p><ul class="ul-2"><li class="li-3"><a href="axios-index.html" class="a-4">介绍</a></li><li class="li-3"><a href="axios-defaults.html" class="a-4">默认值</a></li><li class="li-3"><a href="axios-instance.html" class="a-4">实例化</a></li><li class="li-3"><a href="axios-constructor.html" class="a-4">构建函数</a></li></ul></li><li class="li-1"><p class="a-2">前端面试</p></li><li class="li-1"><p class="a-2">html/css</p><ul class="ul-2"><li class="li-3"><a href="html-html5.html" class="a-4">html5</a></li></ul></li><li class="li-1"><p class="a-2">javascrpt</p><ul class="ul-2"><li class="li-3"><a href="javascript-promis.html" class="a-4">promise 返回值问题？</a></li><li class="li-3"><a href="javascript-render.html" class="a-4">从输入 URL 到页面加载完成的过程中都发生了什么事情？</a></li><li class="li-3"><a href="javascript-clone.html" class="a-4">深拷贝和浅拷贝？</a></li><li class="li-3"><a href="javascript-isnan.html" class="a-4">怎么判断一个变量是不是 NaN?</a></li><li class="li-3"><a href="javascript-reduce.html" class="a-4">array reduce 返回值是什么？</a></li><li class="li-3"><a href="javascript-vueprototype.html" class="a-4">vue 组件挂载到全局方法？</a></li><li class="li-3"><a href="javascript-constructor.html" class="a-4">构造函数的返回值是什么？</a></li><li class="li-3"><a href="javascript-vueinsertcomponent.html" class="a-4">怎么通过编程的方式而不是<'my-component'>的方式动态的插入 Vue components?</a></li><li class="li-3"><a href="javascript-object_get.html" class="a-4">获取对象路径处的值\_.get(object, a.b.c, default)</a></li><li class="li-3"><a href="javascript-null.html" class="a-4">[typeof null, null instanceof Object]表达式的返回值是什么？</a></li><li class="li-3"><a href="javascript-array_map_parseint.html" class="a-4">["1", "2", "3"].map(parseInt) 返回值是什么？</a></li><li class="li-3"><a href="javascript-debounce.html" class="a-4">什么是防抖和节流？有什么区别？如何实现？</a></li><li class="li-3"><a href="javascript-object_defineproperty.html" class="a-4">Object.defineProperty 了解有多少？什么是属性描述符？</a></li><li class="li-3"><a href="javascript-mutationobserver.html" class="a-4">怎么监视对 DOM 树的变化</a></li><li class="li-3"><a href="javascript-vueerror.html" class="a-4">Vue 是怎么进行错误处理的？</a></li><li class="li-3"><a href="javascript-esmodules.html" class="a-4">ES6 Modules？</a></li><li class="li-3"><a href="javascript-bind.html" class="a-4">实现一个 bind 函数？</a></li></ul></li></ul><ul class="ul-0"><li class="li-1"><p class="a-2">基础知识</p></li><li class="li-1"><p class="a-2">设计模式</p><ul class="ul-2"><li class="li-3"><p class="a-4">创建型模式</p><ul class="ul-4"><li class="li-5"><a href="pattern-factory.html" class="a-6">工厂模式</a></li><li class="li-5"><a href="pattern-abstract-factory.html" class="a-6">抽象工厂模式</a></li><li class="li-5"><a href="pattern-singleton.html" class="a-6">单例模式</a></li><li class="li-5"><p class="a-6">[建造者模式]</p></li><li class="li-5"><p class="a-6">[原型模式]</p></li></ul></li><li class="li-3"><p class="a-4">结构型模式</p><ul class="ul-4"><li class="li-5"><p class="a-6">[适配器模式]</p></li><li class="li-5"><p class="a-6">[桥接模式]</p></li><li class="li-5"><a href="pattern-decotators.html" class="a-6">装饰模式</a></li><li class="li-5"><p class="a-6">[组合模式]</p></li><li class="li-5"><p class="a-6">[外观模式]</p></li><li class="li-5"><p class="a-6">[享元模式]</p></li><li class="li-5"><a href="pattern-proxy.html" class="a-6">代理模式</a></li></ul></li><li class="li-3"><p class="a-4">行为型模式</p><ul class="ul-4"><li class="li-5"><p class="a-6">[模板方法模式]</p></li><li class="li-5"><p class="a-6">[命令模式]</p></li><li class="li-5"><p class="a-6">[迭代器模式]</p></li><li class="li-5"><a href="pattern-publishsubscribe.html" class="a-6">观察者模式</a></li><li class="li-5"><p class="a-6">[中介者模式]</p></li><li class="li-5"><p class="a-6">[备忘录模式]</p></li><li class="li-5"><p class="a-6">[解释器模式]</p></li><li class="li-5"><a href="pattern-state.html" class="a-6">状态模式</a></li><li class="li-5"><a href="pattern-strategy.html" class="a-6">策略模式</a></li><li class="li-5"><p class="a-6">[职责链模式]</p></li><li class="li-5"><p class="a-6">[访问者模式]</p></li></ul></li></ul></li><li class="li-1"><p class="a-2">webpack</p><ul class="ul-2"><li class="li-3"><a href="webpack-index.html" class="a-4">webpack</a></li></ul></li></ul>
    </aside>
        <main class="page"><div class="page-bd">
        <h1>axios 的 constructor</h1>
<blockquote>
<p>lib/core/Axios</p>
</blockquote>
<ul>
<li>axios defaults 是怎么从默认-&gt;实例化-&gt;方法调用传递的？</li>
<li>axios 的 request 拦截器异常错误，xhr 请求是否还能正常发出？response 拦截器是否能捕获到错误？</li>
<li>axios 中间件是如何工作的？</li>
</ul>
<details><summary>点击查看源码解读</summary>
<pre><code class="language-javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./../utils"</span>);
<span class="hljs-keyword">var</span> buildURL = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../helpers/buildURL"</span>);
<span class="hljs-keyword">var</span> InterceptorManager = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./InterceptorManager"</span>);
<span class="hljs-keyword">var</span> dispatchRequest = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./dispatchRequest"</span>);
<span class="hljs-keyword">var</span> mergeConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./mergeConfig"</span>);

<span class="hljs-comment">/**
 * 创建Axios实例
 *
 * @param {Object} instanceConfig The default config for the instance
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Axios</span>(<span class="hljs-params">instanceConfig</span>) </span>{
  <span class="hljs-keyword">this</span>.defaults = instanceConfig;
  <span class="hljs-keyword">this</span>.interceptors = {
    <span class="hljs-attr">request</span>: <span class="hljs-keyword">new</span> InterceptorManager(),
    <span class="hljs-attr">response</span>: <span class="hljs-keyword">new</span> InterceptorManager(),
  };
}

<span class="hljs-comment">/**
 * 派发request
 *
 * @param {Object} config The config specific for this request (merged with this.defaults)
 */</span>
Axios.prototype.request = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">request</span>(<span class="hljs-params">config</span>) </span>{
  <span class="hljs-comment">/*eslint no-param-reassign:0*/</span>
  <span class="hljs-comment">// 重载 request(url, config)</span>
  <span class="hljs-comment">// 允许以axios('example/url') 或 axios('example/url', config) 方式调用</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> config === <span class="hljs-string">"string"</span>) {
    config = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>] || {};
    config.url = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>];
  } <span class="hljs-keyword">else</span> {
    config = config || {};
  }

  config = mergeConfig(<span class="hljs-keyword">this</span>.defaults, config); <span class="hljs-comment">// ③调用方法时候传入的defaults</span>

  <span class="hljs-comment">// Set config.method</span>
  <span class="hljs-keyword">if</span> (config.method) {
    config.method = config.method.toLowerCase();
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.defaults.method) {
    config.method = <span class="hljs-keyword">this</span>.defaults.method.toLowerCase();
  } <span class="hljs-keyword">else</span> {
    config.method = <span class="hljs-string">"get"</span>;
  }

  <span class="hljs-comment">// Hook 拦截器中间件</span>
  <span class="hljs-keyword">var</span> chain = [dispatchRequest, <span class="hljs-literal">undefined</span>];
  <span class="hljs-keyword">var</span> promise = <span class="hljs-built_in">Promise</span>.resolve(config);

  <span class="hljs-keyword">this</span>.interceptors.request.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unshiftRequestInterceptors</span>(<span class="hljs-params">
    interceptor
  </span>) </span>{
    chain.unshift(interceptor.fulfilled, interceptor.rejected);
  });

  <span class="hljs-keyword">this</span>.interceptors.response.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pushResponseInterceptors</span>(<span class="hljs-params">
    interceptor
  </span>) </span>{
    chain.push(interceptor.fulfilled, interceptor.rejected);
  });

  <span class="hljs-keyword">while</span> (chain.length) {
    promise = promise.then(chain.shift(), chain.shift());
  }

  <span class="hljs-keyword">return</span> promise;
};

Axios.prototype.getUri = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUri</span>(<span class="hljs-params">config</span>) </span>{
  config = mergeConfig(<span class="hljs-keyword">this</span>.defaults, config);
  <span class="hljs-keyword">return</span> buildURL(config.url, config.params, config.paramsSerializer).replace(
    <span class="hljs-regexp">/^\?/</span>,
    <span class="hljs-string">""</span>
  );
};

<span class="hljs-comment">// 复用请求方法，提供请求别名</span>
utils.forEach(
  [<span class="hljs-string">"delete"</span>, <span class="hljs-string">"get"</span>, <span class="hljs-string">"head"</span>, <span class="hljs-string">"options"</span>],
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">forEachMethodNoData</span>(<span class="hljs-params">method</span>) </span>{
    <span class="hljs-comment">/*eslint func-names:0*/</span>
    Axios.prototype[method] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url, config</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.request(
        utils.merge(config || {}, {
          <span class="hljs-attr">method</span>: method,
          <span class="hljs-attr">url</span>: url,
        })
      );
    };
  }
);

utils.forEach([<span class="hljs-string">"post"</span>, <span class="hljs-string">"put"</span>, <span class="hljs-string">"patch"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">forEachMethodWithData</span>(<span class="hljs-params">method</span>) </span>{
  <span class="hljs-comment">/*eslint func-names:0*/</span>
  Axios.prototype[method] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url, data, config</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.request(
      utils.merge(config || {}, {
        <span class="hljs-attr">method</span>: method,
        <span class="hljs-attr">url</span>: url,
        <span class="hljs-attr">data</span>: data,
      })
    );
  };
});

<span class="hljs-built_in">module</span>.exports = Axios;
</code></pre>
</details>
<h2>chain 执行流程</h2>
<h3>以下为 request 拦截器报错</h3>
<pre><code class="language-js">axios.interceptors.request.use(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-built_in">console</span>.info(<span class="hljs-string">`request: resolve-&gt;1`</span>);
    <span class="hljs-keyword">return</span> config;
  },
  () =&gt; {
    <span class="hljs-built_in">console</span>.info(<span class="hljs-string">"request: reject-&gt;1"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(<span class="hljs-string">"reject-&gt;1"</span>);
  }
);
axios.interceptors.request.use(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"request: reject-&gt;2"</span>);
  <span class="hljs-keyword">return</span> config;
});
axios.interceptors.request.use(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.info(<span class="hljs-string">`request: resolve-&gt;3`</span>);
  <span class="hljs-keyword">return</span> config;
});

axios.interceptors.response.use(
  <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {},
  (err) =&gt; {
    <span class="hljs-built_in">console</span>.info(<span class="hljs-string">`response: <span class="hljs-subst">${err}</span>`</span>);
  }
);

<span class="hljs-comment">/*
chain: [ƒ, undefined, ƒ, undefined, ƒ, ƒ, ƒ, undefined, ƒ, ƒ]
第1次执行: [ƒ, undefined] -&gt; f =&gt; promise.resolve
    [ƒ, undefined, ƒ, ƒ, ƒ, undefined, ƒ, ƒ]
    request: resolve-&gt;3
第2次执行: [ƒ, undefined] -&gt; f =&gt; promise.reject
    [ƒ, ƒ, ƒ, undefined, ƒ, ƒ]
第3次执行:[f, f] -&gt; f =&gt; promise.reject
    [ƒ, undefined, ƒ, ƒ]
    request: reject-&gt;1
第4次执行: [ƒ, undefined] -&gt; promise.reject
    [ƒ, ƒ]
第5次执行: [ƒ, ƒ]
    []
    response: request: reject-&gt;1
*/</span>
</code></pre>
<div class="page-nav"><a class="pre" href="axios-instance.html">←实例化</a><a class="next" href="html-html5.html">html5→</a></div>
        </div>
    </main>
        </div>
        <script  src="../assets/app.js"></script>
        <script src="../assets/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
        <footer class="footer"></footer>

    </body>
    </html>